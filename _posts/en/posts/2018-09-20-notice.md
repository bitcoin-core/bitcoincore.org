---
title: CVE-2018-17144 Full Disclosure
name: cve-2018-17144-full-disclosure
id: en-cve-2018-17144-full-disclosure
lang: en
type: posts
layout: post
share: true

## If this is a new post, reset this counter to 1.
version: 1

excerpt: >
  A full disclosure of the impact of CVE-2018-17144, a fix for which was
  released on September 18th in Bitcoin Core versions 0.16.3 and
  0.17.0RC4.
---

Full disclosure
===============
CVE-2018-17144, a fix for which was released on September 18th in Bitcoin Core versions 0.16.3 and 0.17.0rc4, includes both a Denial of Service component and a critical inflation vulnerability. It was originally reported to several developers working on Bitcoin Core, as well as projects supporting other cryptocurrencies, including ABC and Unlimited on September 17th as a Denial of Service bug only, however we quickly determined that the issue was also an inflation vulnerability with the same root cause and fix.

In order to encourage rapid upgrades, the decision was made to immediately patch and disclose the less serious Denial of Service vulnerability, concurrently with reaching out to miners, businesses, and other affected systems while delaying publication of the full issue to give times for systems to upgrade. On September 20th a post in a public forum reported the full impact and although it was quickly retracted the claim was further circulated.

At this time we believe over half of the Bitcoin hashrate has upgraded to patched nodes. We are unaware of any attempts to exploit this vulnerability.

However, it still remains critical that affected users upgrade and apply the latest patches to ensure no possibility of large reorganizations, mining of invalid blocks, or acceptance of invalid transactions occurs.

Technical Details
=================

The original implementation of Bitcoin ensured that no transaction
within a block spent an input that had already been spent on the same
block chain.  However, it failed to ensure that the transactions it
relayed and accepted into its memory pool only spent the same input
once, so PR #443 was opened to add a rule that rejected transactions
with duplicate inputs.  This became part of the 0.4 release of Bitcoin.

This new rule was added to the function used to validate all
transactions, whether they were unconfirmed transactions being relayed
or transactions included in blocks, which meant that Bitcoin software
was redundantly checking blocks for duplicate inputs twice:

1. When validating each transaction in the block using the `CheckTransaction`
   function

2. When updating the transaction database using the `ConnectBlock`
   function

In Bitcoin Core 0.14, an optimization was added (PR #9049) which eliminated this redundancy. While the UTXO-updating logic has sufficient knowledge to check that such a condition is not violated in 0.14, it only did so in a sanity check assertion and not with full error handling.

Thus, in Bitcoin Core 0.14.X, any attempts to double-spend a transaction output within a single transaction inside of a block will result in an assertion failure and a crash, as was originally reported.

In Bitcoin Core 0.15, as a part of a larger redesign to simplify unspent transaction output tracking and correct a resource exhaustion attack the assertion was changed subtly. Instead of asserting that the output being marked spent was previously unspent, it only asserts that it exists.

Thus, in Bitcoin Core 0.15.X, 0.16.0, 0.16.1, and 0.16.2, any attempts to double-spend a transaction output within a single transaction inside of a block where the output being spent was created in the same block, the same assertion failure will occur (as exists in the test case which was included in the 0.16.3 patch). However, if the output being double-spent was created in a previous block, an entry will still remain in the CCoin map with the DIRTY flag set and having been marked as spent, resulting in no such assertion. This could allow a miner to inflate the supply of Bitcoin as they would be then able to claim the value being spent twice.

Timeline
========

Timeline for September 17, 2018: (all times UTC)

- 14:57 anonymous reporter reports crash bug to: Pieter Wuille, Greg Maxwell, Wladimir Van Der Laan of Bitcoin Core, deadalnix of Bitcoin ABC, and sickpig of Bitcoin Unlimited.
- 15:15 Greg Maxwell shares the original report with Cory Fields, Suhas Daftuar, Alex Morcos and Matt Corallo
- 17:47 Matt Corallo identifies inflation bug
- 19:15 Matt Corallo first tries to reach slushpool CEO to have a line of communication open to apply a patch quickly
- 19:29 Greg Maxwell timestamps the hash of a test-case which demonstrates the inflation vulnerability (a47344b7dceddff6c6cc1c7e97f1588d99e6dba706011b6ccc2e615b88fe4350)
- 20:15 John Newbery and James O'Beirne are informed of the vulnerability so they can assist in alerting companies to a pending patch for a DoS vulnerability
- 20:30 Matt Corallo speaks with slushpool CTO and CEO and shares patch with disclosure of the Denial of Service
- 20:48 slushpool confirmed upgraded 
- 21:08 Alert was sent to Bitcoin ABC that a patch will be posted publicly by 22:00
- 21:30 (approx)  Responded to original reporter with an acknowledgment
- 21:57 Bitcoin Core PR 14247 published with patch and test demonstrating the Denial of Service bug
- 21:58 Bitcoin ABC publishes their patch
- 22:07 Advisory email with link to Bitcoin Core PR and patch goes out to Optech members, among others
- 23:21 Bitcoin Core version 0.17.0rc4 tagged

September 18, 2018:

- 00:24 Bitcoin Core version 0.16.3 tagged
- 20:44 Bitcoin Core release binaries and release announcements were available
- 21:47 Bitcointalk and reddit have public banners urging people to upgrade

September 19, 2018: 

- 14:06  The mailing list distributes an additional message urging people to upgrade by Pieter Wuille

September 20, 2018: 

- 19:50 David Jaenson independently discovered the vulnerability, and it was reported to the Bitcoin Core security contact email.

{% include references.md %}
